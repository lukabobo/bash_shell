# Chapter 8: Job và process

## 8.1. Xử lý job

### Tạo job

Để tạo job, chỉ cần thêm dấu `&` sau lệnh. 

`&` không phải là một tham số cho chương trình. Nó cho shell. `&` là chạy chương trình ở chế độ nền trong shell.

    [root@localhost opt]# sleep 10 &
    [1] 17709

Ví dụ trên sleep hệ thống trong 10s. Nếu không có dấu `&` thì phải đợi 10s sau mới có thể nhập lệnh tiếp theo. Khi có dấu `&`, việc sleep sẽ được chạy nền, chúng ta có thể nhập lệnh tiếp theo ngay.

- [1] Là thứ tự job đang thực hiện
- 17709 là process ID (PID)

Có thể biến một process đang chạy thành 1 job bằng tổ hợp `ctrl + z`

    [root@localhost opt]# sleep 10
    ^Z
    [1]+  Stopped                 sleep 10

### Đặt process chạy nền (background) hoặc chạy trước (foreground)

Để mang process lên foreground. Dùng lệnh `fg` và `%`

    [root@localhost opt]# sleep 10 &
    [2] 17726
    [root@localhost opt]# fg %1
    sleep 10
    [root@localhost opt]#

Bây giờ có thể tương tác với process. 

Để mang process xuống lại background, dùng lệnh `bg`. Trước đó cần dừng process bằng tổ hợp `ctrl + z`

    [root@localhost opt]# sleep 10
    ^Z
    [1]+  Stopped                 sleep 10
    [root@localhost opt]# bg %1
    [1]+ sleep 10 &
    [root@localhost opt]#

Nếu chỉ có 1 process đang chạy thì không cần phải thêm PID vào sau dấu `%` trong lệnh `fg` và `bg`

    [root@localhost opt]# sleep 10 &
    [2] 17733
    [1]   Done                    sleep 10
    [root@localhost opt]# fg %
    sleep 10

Hoặc

    [root@localhost opt]# sleep 10 &
    [1] 17734
    [root@localhost opt]# %
    sleep 10
    [root@localhost opt]#

Chỉ cần gõ `fg` hoặc `bg` có thể xử lý job gần nhất

    [root@localhost opt]# sleep 20 &
    [1] 17768
    [root@localhost opt]# sleep 10 &
    [2] 17769
    [root@localhost opt]# fg
    sleep 10
    ^C
    [root@localhost opt]# fg
    sleep 20

### Kill job đang hoạt chạy

    [root@localhost opt]# sleep 10 &
    [1] 17770
    [root@localhost opt]# kill %1
    [root@localhost opt]# ss
    [1]+  Terminated              sleep 10

Process sleep chạy nền với PID là 17770 và job number là 1. Có thể xác định process với PID hoặc job number. Nết dùng job number thì phải có % đi kèm. 

Tín hiệu kill mặc định gửi bởi kill là SIGTERM, cho phép process mục tiệu thoát mà không bị ảnh hưởng.

Một số tín hiệu của lệnh kill phổ biến. Để xem đầy đủ sử dụng `kill -l`

| Signal name | Signal value  | Tác dụng |
|-----|:-----:|-----|
| SIGHUP   | 1    | hangup    |
| SIGINT  | 2    | Ngắt từ bàn phím    |
| SIGKILL | 9    | tín hiệu kill   |
| SIGTERM | 15    | tín hiệu kết thúc    |

### Khởi động và kill tiến trình cụ thể

Cách dễ nhất để kill tiến trình là sử dụng tên tiến trình. Ví dụ:

    pkill -f test.py

Hoặc chi tiết hơn với pgrep để tìm PID

    kill $(pgrep -f 'python test.py')

Cách tương tự là dùng `ps -ef | grep tên_process` rồi kill process cần thiết.

## 8.2. Kiểm tra process nào đang chạy trên port cụ thể nào

Cú pháp:

    lsof -i :số-port

Ví dụ kiểm tra process nào đang chạy trên port 80

    lsof -i :80

Cài đặt `lsof` bằng lệnh `yum -y install lsof`

    [root@localhost opt]# lsof -i :80
    COMMAND PID  USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
    nginx   874  root    8u  IPv4  15794      0t0  TCP *:http (LISTEN)
    nginx   874  root    9u  IPv6  15795      0t0  TCP *:http (LISTEN)
    nginx   878 nginx    8u  IPv4  15794      0t0  TCP *:http (LISTEN)
    nginx   878 nginx    9u  IPv6  15795      0t0  TCP *:http (LISTEN)
    nginx   879 nginx    8u  IPv4  15794      0t0  TCP *:http (LISTEN)
    nginx   879 nginx    9u  IPv6  15795      0t0  TCP *:http (LISTEN)
    [root@localhost opt]#

## 8.3. Disown (từ chối) job chạy nền

    $ gzip extremelylargefile.txt &
    $ bg
    $ disown %1

Điều này cho phép một process chạy lâu có thể tiếp tục khi shell (terminal, ssh, vv...) đã đóng.

## 8.4. Liệt kê các job hiện tại

Sử dụng lệnh 

    jobs

## 8.5. Tìm thông tin về process

Dùng `ps`

    ps -aux | grep từ-khóa-liên-quan-cần-tìm

VÍ dụ:

    [root@localhost opt]# ps -aux | grep nginx
    root       874  0.0  0.0  49672  1164 ?        Ss   Sep10   0:00 nginx: master process /usr/sbin/nginx
    nginx      878  0.0  0.1  50112  1900 ?        S    Sep10   0:00 nginx: worker process
    nginx      879  0.0  0.1  50112  1900 ?        S    Sep10   0:00 nginx: worker process
    root     17841  0.0  0.0 112812   976 pts/0    S+   11:26   0:00 grep --color=auto nginx
    [root@localhost opt]#

## 8.6. Liệt kê tất cả process

Dùng lệnh

    ps -ef

Hoặc

    ps aux
