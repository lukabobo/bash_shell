## Chapter 10: Cấu trúc điều khiển

| Toán tử tệp | Mô tả  |
|-----|:-----|
| -e "$file"  |  Trả về true nếu tệp tồn tại    |
| -d "$file"  | Trả về true nếu tồn tại và là một thư mục    |
| -f "$file" |  Trả về true nếu tồn tại và là tệp thông thường    |
| -h "$file"  |  Trả về true nếu tồn tại và là một liên kết tượng trưng (symbolic link)   |

| Toán tử chuỗi | Mô tả  |
|-----|:-----|
| -z "$str"  |  True nếu độ dài chuỗi là 0    |
| -n "$str  | True nếu độ dài chuỗi khác 0    |
| "$str" = "$str2" |  True nếu chuỗi $str bằng chuỗi $str2. Không nên dùng cho số nguyên    |
| "$str" != "$str2" |  True nếu các chuỗi không bằng nhau    |

| So sánh số nguyên | Mô tả  |
|-----|:-----|
| "$int1" -eq "$int2" |  True nếu các số nguyên bằng nhau    |
| "$int1" -ne "$int2" | True nếu các số nguyên khác nhau    |
| "$int1" -gt "$int2"  |  True nếu int1 lớn hơn int2    |
| "$int1" -ge "$int2" | True nếu int1 lớn hơn hoặc bằng int2    |
| "$int1" -lt "$int2"  |  True nếu int1 nhỏ hơn int2    |
| "$int1" -le "$int2"  | True nếu int1 nhỏ hơn hoặc bằng int2    |

## 10.1. Thực hiện có điều kiện các danh sách lệnh

Bất kỳ lệnh, biểu thức hoặc hàm nội tại nào cũng như bất kỳ lệnh hoặc tập lệnh bên ngoài nào đều có thể được thực thi có điều kiện sử dụng các toán tử `&&` (và) và `||` (hoặc)

Ví dụ: Chỉ in ra đường dẫn thư mục nều lệnh cd thành công

    cd my_directory && pwd

Thoát nếu lệnh cd thất bại. Tránh việc xóa nhầm.

    cd my_directory || exit
    rm -rf *

Khi kết hợp nhiều câu lệnh theo cách này, các toán tử không được ưu tiên và Liên kết ngược

    cd my_directory && pwd || echo "No such directory"

- Nếu thực hiện cd thành công thì sẽ thực hiện pwd và không thực hiện echo
- Nếu cd không thành công thực hiện lệnh echo

### Tại sao sử dụng thực thi có điều kiện của danh sách lệnh

Thực thi có điều kiện nhanh hơn if…then nhưng lợi thế chính của nó là cho phép các function và script thoát sớm.

Trong một số trường hợp, không phải dọn dẹp bất cứ thứ gì trước khi rời khỏi function. Lệnh return sẽ giải quyết mọi thứ trong function và thực thi nhận lại là thứ return trả về trên stack.

Trở lại từ các chức năng hoặc thoát script càng sớm càng tốt, do đó có thể cải thiện hiệu suất và giảm tải hệ thống bằng cách tránh thực thi mã không cần thiết.

## 10.2. Câu lệnh if

    if [[ $1 -eq 1 ]]; then
        echo "1 was passed in the first parameter"
    elif [[ $1 -gt 2 ]]; then
        echo "2 was not passed in the first parameter"
    else
        echo "The first parameter was not 1 and is not more than 2."
    fi

Việc dùng fi để đóng là bắt buộc, nhưng có thể bỏ qua elif hoặc else hoặc các mệnh đề khác.

Dấu chấm phẩy là cú pháp tiêu chuẩn để kết hợp hai lệnh trên một dòng, `;` có thể được bỏ qua chỉ khi sau đó được chuyển sang dòng tiếp theo.

Dấu ngoặc `[[` không phải là một phần của cú pháp, nhưng được coi như một lệnh; Nó là mã thoát của lệnh khi được kiểm tra. Do đó, bạn phải luôn bao gồm các khoảng trắng xung quanh dấu ngoặc vuông.

Điều này cũng có nghĩa là kết quả của bất kỳ lệnh nào cũng có thể được kiểm tra. Nếu exit code từ câu lệnh là 0, câu điều kiện được coi là đúng.

    if grep "foo" bar.txt; then
        echo "foo was found"
    else
        echo "foo was not found"
    fi

Các biểu thức toán học, khi được đặt tên bên trong dấu ngoặc kép, cũng trả về 0 hoặc 1 theo cách tương tự

    if (( $1 + 5 > 91 )); then
        echo "$1 is greater than 86"
    fi

Bạn cũng có thể bắt gặp câu lệnh if có dấu ngoặc đơn. Chúng được xác định trong tiêu chuẩn POSIX và được đảm bảo hoạt động trong tất cả các trình bao tương thích với POSIX bao gồm cả Bash. Cú pháp rất giống với cú pháp trong Bash:

    if [ "$1" -eq 1 ]; then
        echo "1 was passed in the first parameter"
    elif [ "$1" -gt 2 ]; then
        echo "2 was not passed in the first parameter"
    else
        echo "The first parameter was not 1 and is not more than 2."
    fi

## 10.3. Vòng lặp qua một mảng

Vòng lặp for

    arr=(a b c d e f)
    for i in "${arr[@]}";do
        echo "$i"
    done

Hoặc

    arr=(a b c d e f)
    for ((i=0;i<${#arr[@]};i++));do
        echo "${arr[$i]}"
    done

Vòng lặp while

    arr=(a b c d e f)
    i=0
    while [ $i -lt ${#arr[@]} ];do
        echo "${arr[$i]}"
        i=$(expr $i + 1)
    done

Hoặc

    arr=(a b c d e f)
    i=0
    while (( $i < ${#arr[@]} ));do
        echo "${arr[$i]}"
        ((i++))
    done

Cả 4 vòng lặp trên đều cho ra output

    a
    b
    c
    d
    e
    f

## 10.4. Sử dụng vòng lặp For để liệt kê Lặp lại trên các số

Vòng lặp for hoạt động trên các danh sách của các mục (item). Nó lặp đi lặp lại một tập hợp các lệnh cho mỗi mục trong một danh sách.

Cú pháp:

    for var in word1 word2 ... wordN
    do
        các lệnh để thực thi cho mỗi word.
    done

Ví dụ:

    for i in 0 1 2 3 4 5 6 7 8 9 10
    do
        echo $i
    done

hoặc

    #! /bin/bash
    for i in {1..10}; do 
        echo $i
    done

`{1..10}` mở rộng tới "1 2 3 4 5 6 7 8 9 10"

Output

    1
    2
    3
    4
    5
    6
    7
    8
    9
    10

### Vòng lặp với một số

Chúng ta có thể chỉ định một phạm vi trong các vòng lặp như sau:

    for i in {START..END}
    do
        commands
    done

    ## step value ##
    for i in {START..END..STEP}
    do
        commands
    done

    ## example: ping cbz01, cbz02, cbz03, and cbz04 using a loop ##
    for i in 0{1..4}
    do
        h="cbz${i}"
        ping -c 1 -q "$h" &>/dev/null 
        if [ $? -eq 0 ]
        then
            echo "server $h alive" 
        else
            echo "server $h dead or can not ping."
        fi
    done

### Thay thế lệnh

Thay thế lệnh có nghĩa là chạy lệnh shell và lưu trữ đầu ra của nó vào một biến. chẳng hạn:

    up=$(uptime)
    echo "Server uptime is $up"

Danh sách đối số vòng lặp cũng hoạt động thay thế lệnh như sau:

    for var in $(command)
    do
        print "$var"
    done

ví dụ   

    for f in $(ls /nas/*.pdf)
    do
        print "File $f"
    done

## 10.5. Tiếp tục (continue) và ngắt (break)

Ví dụ continue

    for i in [series]
    do
        lệnh 1
        lệnh 2
        if (điều kiện) # điều kiện để đi đến lệnh 3
            continue # nhảy tới giá trị tiếp theo trong "series"
        fi
        lệnh 3
    done

Ví dụ break

    for i in [series]
    do
        lệnh 4
        if (điều kiện) # điều kiện để ngắt vòng lặp
        then
            lệnh 5 # lệnh if vòng lặp cần để ngắt
            break
        fi
        lệnh 6 # lệnh để chạy nếu "điều kiện" không đúng
    done

continue: bỏ qua các lệnh còn lại bên trong phần thân của vòng lặp đi kèm cho lần lặp hiện tại và chuyển quyền điều khiển chương trình cho lần lặp tiếp theo của vòng lặp.

    i=0
    while [[ $i -lt 5 ]]; do
    ((i++))
        if [[ "$i" == '2' ]]; then
            continue
        fi
        echo "Number: $i"
    done

    echo 'All Done!'

Output

    Number: 1
    Number: 3
    Number: 4
    Number: 5
    All Done!

break: lệnh kết thúc vòng lặp hiện tại và chuyển điều quyền điều khiển chương trình cho lệnh sau vòng lặp kết thúc. Nó được sử dụng để thoát vòng lặp for, while , until, select.

    i=0
    while [[ $i -lt 5 ]]
    do
        echo "Number: $i"
        ((i++))
        if [[ $i -eq 2 ]]; then
            break
        fi
    done
    echo 'All Done!'

Output

    Number: 0
    Number: 1
    All Done!

## 10.6. Vòng lặp break

Nhiều vòng lặp break

    arr=(a b c d e f)
    for i in "${arr[@]}";do
        echo "$i"
        for j in "${arr[@]}";do
            echo "$j"
            break 2
        done
    done

Output:

    a
    a

Một vòng lặp break

    arr=(a b c d e f)
    for i in "${arr[@]}";do
        echo "$i"
        for j in "${arr[@]}";do
            echo "$j"
            break
        done
    done

Output

    a
    a
    b
    a
    c
    a
    d
    a
    e
    a
    f
    a

## 10.7. Vòng lặp while

Vòng lặp while cho bạn khả năng thực thi một tập hợp các lệnh lặp đi lặp lại cho tới khi một số điều kiện xảy ra. Nó thường được sử dụng khi bạn cần thao tác giá trị biến lặp đi lặp lại.

Cú pháp

    while command
    do
        cac lenh de thuc thi neu command la true
    done

Ví dụ:

    #! /bin/bash

    i=0

    while [ $i -lt 5 ] #While i nhỏ hơn 5
    do
        echo "i = $i"
        i=$[$i+1] #Không để có dấu cách bên trong ngoặc. Nếu không nó sẽ bị hiểu là một biểu thức kiểm tra
    done

Output

    i = 0
    i = 1
    i = 2
    i = 3
    i = 4

## 10.8. Vòng lặp for với cú pháp kiểu C

Cú pháp cơ bản của vòng lặp for kiểu C là:

    for (( variable assignment; condition; iteration process ))
    for ((gán biến; điều kiện; quá trình lặp))

Chú ý:

- Việc gán biến bên trong vòng lặp for kiểu C có thể chứa khoảng trắng không giống như phép gán thông thường

- Các biến bên trong vòng lặp for kiểu C không được đi trước với $

Ví dụ:

    for (( i = 0; i < 10; i++ ))
    do
        echo "The iteration number is $i"
    done

Ngoài ra, chúng ta có thể xử lý nhiều biến bên trong Vòng lặp for kiểu C

    for (( i = 0, j = 0; i < 10; i++, j = i * i ))
    do
        echo "The square of $i is equal to $j"
    done

## 10.9. Vòng lặp until

Vòng lặp until thực hiện cho đến khi điều kiện đúng

    i=5
    until [[ i -eq 10 ]]; do #Checks if i=10
        echo "i=$i" #Print the value of i
        i=$((i+1)) #Increment i by 1
    done

Output:

    i=5
    i=6
    i=7
    i=8
    i=9

Khi i đạt đến 10, điều kiện của vòng lặp until đúng và vòng lặp kết thúc.

## 10.10. Chuyển câu lệnh với case

Lệnh case thường được sử dụng để đơn giản hóa các điều kiện phức tạp khi bạn có nhiều sự lựa chọn khác nhau sẽ giúp bạn làm cho các script của mình dễ đọc hơn và dễ bảo trì hơn.

Đối với case statement bạn có thể so khớp giá trị với một biến

Đối số được truyền vào case được mở rộng và gắp khớp với từng mẫu.

Nếu một kết quả được tìm thấy là phù hợp, các lệnh ;; được thực hiện.

    case "$BASH_VERSION" in
        [34]*)
            echo {1..4}
            ;;
        *)
            seq -s" " 1 4
    esac

## 10.11. Vòng lặp for với tham số list-of-word

    for arg; do
        echo arg=$arg
    done

Một vòng lặp for không có danh sách các tham số sẽ lặp qua các tham số vị trí. Nói cách khác, ví dụ trên tương đương với đoạn code sau:

    for arg in "$@"; do
        echo arg=$arg
    done

Nói ngắn gọn:

    for i in "$@"; do ...; done 

Có thể được viết thành

    for i; do ...; done

## 10.12. Lồng các vòng lặp

Tất cả các vòng lặp hỗ trợ khái niệm lồng, có nghĩa là bạn có thể đặt một vòng lặp vào bên trong một vòng lặp tương tự hoặc các vòng lặp khác. Việc lồng này có thể không giới hạn số lượng tối đa vòng lặp, nó phụ thuộc vào yêu cầu của bạn.

Dưới đây là ví dụ của lồng vòng lặp while, và theo cách tương tự, các vòng lặp khác có thể được lồng tùy theo yêu cầu chương trình.

Có thể để sử dụng vòng lặp while như là một phần của thân của một vòng lặp while khác.

Cú pháp:

    while command1 ; # Day la vong lap thu nhat, la vong lap ben ngoai
    do
        Cac lenh de thuc thi neu command1 la true

        while command2 ; # Day la vong lap thu hai, la vong lap ben trong
        do
            Cac lenh de thuc thi neu command2 la true
        done

        Cac lenh de thuc thi neu command1 la true
    done

Ví dụ: 

    #!/bin/sh

    a=0
    while [ "$a" -lt 10 ]    # this is loop1
    do
        b="$a"
        while [ "$b" -ge 0 ]  # this is loop2
        do
            echo -n "$b "
            b=`expr $b - 1`
        done
        echo
        a=`expr $a + 1`
    done

Output:

    0
    1 0
    2 1 0
    3 2 1 0
    4 3 2 1 0
    5 4 3 2 1 0
    6 5 4 3 2 1 0
    7 6 5 4 3 2 1 0
    8 7 6 5 4 3 2 1 0
    9 8 7 6 5 4 3 2 1 0

Tại đây tùy chọn `-n` của lệnh `echo` cho phép tránh việc in một dòng ký tự mới.

## Tham khảo thêm

https://hocdevops.com/commands/vong-lap-trong-bash/

https://hoclaptrinh.vn/tutorial/hoc-unix/vong-lap-trong-unix-linux